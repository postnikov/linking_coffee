#!/usr/bin/env node

/**
 * Airtable Schema Documentation Generator
 * 
 * This script fetches the current schema from Airtable and generates
 * a markdown documentation file with all tables and their fields.
 * 
 * Usage:
 *   node scripts/update-schema-docs.js
 * 
 * Configuration:
 *   - Ensure .env file contains:
 *     - AIRTABLE_API_KEY
 *     - AIRTABLE_BASE_ID
 * 
 * Output:
 *   - Updates docs/DATABASE_SCHEMA.md
 */

require('dotenv').config({ path: require('path').join(__dirname, '../.env') });
const fs = require('fs');
const path = require('path');

const AIRTABLE_API_KEY = process.env.AIRTABLE_API_KEY;
const AIRTABLE_BASE_ID = process.env.AIRTABLE_BASE_ID;

if (!AIRTABLE_API_KEY || !AIRTABLE_BASE_ID) {
    console.error('‚ùå Error: AIRTABLE_API_KEY and AIRTABLE_BASE_ID must be set in .env');
    process.exit(1);
}

/**
 * Fetch base schema from Airtable Meta API
 */
async function fetchBaseSchema() {
    const url = `https://api.airtable.com/v0/meta/bases/${AIRTABLE_BASE_ID}/tables`;

    console.log('üì° Fetching schema from Airtable...');

    const response = await fetch(url, {
        headers: {
            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
        }
    });

    if (!response.ok) {
        throw new Error(`Failed to fetch schema: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();
    return data.tables;
}

/**
 * Format field type for documentation
 */
function formatFieldType(field) {
    const type = field.type;

    // Add options for specific field types
    if (type === 'singleSelect' && field.options?.choices) {
        const choices = field.options.choices.map(c => c.name).join(', ');
        return `${type} (${choices})`;
    }

    if (type === 'multipleSelects' && field.options?.choices) {
        const choices = field.options.choices.map(c => c.name).join(', ');
        return `${type} (${choices})`;
    }

    if (type === 'singleLineText' || type === 'multilineText') {
        return 'Text';
    }

    if (type === 'number') {
        return 'Number';
    }

    if (type === 'checkbox') {
        return 'Boolean';
    }

    if (type === 'date' || type === 'dateTime') {
        return 'Date/Time';
    }

    if (type === 'multipleRecordLinks') {
        return `Link to ${field.options?.linkedTableId || 'another table'}`;
    }

    return type;
}

/**
 * Generate markdown documentation
 */
function generateMarkdown(tables) {
    const timestamp = new Date().toISOString();

    let markdown = `# Airtable Database Schema

**Last Updated:** ${timestamp}

This document is auto-generated by \`scripts/update-schema-docs.js\`.

## Overview

This database contains ${tables.length} table(s).

---

`;

    // Generate documentation for each table
    for (const table of tables) {
        markdown += `## ${table.name}\n\n`;

        if (table.description) {
            markdown += `${table.description}\n\n`;
        }

        markdown += `**Table ID:** \`${table.id}\`\n\n`;
        markdown += `### Fields\n\n`;
        markdown += `| Field Name | Type | Description |\n`;
        markdown += `|------------|------|-------------|\n`;

        for (const field of table.fields) {
            const fieldName = field.name;
            const fieldType = formatFieldType(field);
            const description = field.description || '-';

            markdown += `| ${fieldName} | ${fieldType} | ${description} |\n`;
        }

        markdown += `\n`;

        // Add primary field info
        const primaryField = table.fields.find(f => f.id === table.primaryFieldId);
        if (primaryField) {
            markdown += `**Primary Field:** ${primaryField.name}\n\n`;
        }

        markdown += `---\n\n`;
    }

    return markdown;
}

/**
 * Main execution
 */
async function main() {
    try {
        console.log('üöÄ Starting schema documentation update...\n');

        // Fetch schema
        const tables = await fetchBaseSchema();
        console.log(`‚úÖ Fetched schema for ${tables.length} table(s)\n`);

        // Generate markdown
        const markdown = generateMarkdown(tables);

        // Write to file
        const outputPath = path.join(__dirname, '../docs/DATABASE_SCHEMA.md');
        fs.writeFileSync(outputPath, markdown, 'utf8');

        console.log(`‚úÖ Schema documentation updated: ${outputPath}\n`);
        console.log('üìä Summary:');

        for (const table of tables) {
            console.log(`   - ${table.name}: ${table.fields.length} fields`);
        }

        console.log('\n‚ú® Done!');

    } catch (error) {
        console.error('‚ùå Error:', error.message);
        process.exit(1);
    }
}

// Run the script
main();
