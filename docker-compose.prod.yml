services:
  # Backend API
  backend:
    image: linking-coffee-backend:latest
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: linking-coffee-backend
    restart: unless-stopped
    volumes:
      - /opt/linking-coffee/config:/app/config
      - /opt/linking-coffee/logs:/app/logs
      - /opt/linking-coffee/backups:/app/backups
    env_file: .env
    environment:
      - NODE_ENV=production
      - FRONTEND_URL=${FRONTEND_URL:-https://linked.coffee}
      - PORT=3001
      - ENABLE_SCHEDULER=false
    networks:
      - linking-coffee-network
      - traefik-public
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Scheduler (separate process for reliability)
  scheduler:
    image: linking-coffee-backend:latest
    container_name: linking-coffee-scheduler
    restart: unless-stopped
    command: ["node", "scheduler-worker.js"]
    volumes:
      - /opt/linking-coffee/config:/app/config
      - /opt/linking-coffee/logs:/app/logs
      - /opt/linking-coffee/backups:/app/backups
    env_file: .env
    environment:
      - NODE_ENV=production
      - SCHEDULER_HEALTH_PORT=3002
    networks:
      - linking-coffee-network
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Frontend
  frontend:
    image: linking-coffee-frontend:latest
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - REACT_APP_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
        - REACT_APP_TELEGRAM_BOT_NAME=${REACT_APP_TELEGRAM_BOT_NAME:-Linked_Coffee_Bot}
    container_name: linking-coffee-frontend
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - linking-coffee-network
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.linking-coffee.rule=Host(`linked.coffee`)"
      - "traefik.http.routers.linking-coffee.entrypoints=websecure"
      - "traefik.http.routers.linking-coffee.tls.certresolver=myresolver"
      - "traefik.http.services.linking-coffee.loadbalancer.server.port=80"

networks:
  linking-coffee-network:
    driver: bridge
  traefik-public:
    external: true
